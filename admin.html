<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SPTA Admin</title>
  <meta name="description" content="Admin dashboard for SPTA Transparency Portal – manage resolutions, officers, announcements, and finance." />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f7fb}
    .shadow-soft{box-shadow:0 8px 30px rgba(0,0,0,.06)}
    .card{border:0;border-radius:1rem}
    .nav-pills .nav-link{border-radius:.75rem}
    .table thead th{white-space:nowrap}
    .header{position:sticky;top:0;z-index:1030}
    .mini{font-size:.9rem}
    .pointer{cursor:pointer}
    .form-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:.75rem}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 12)
    .col-4{grid-column:span 12}
    .col-3{grid-column:span 12}
    @media(min-width:768px){
      .col-6{grid-column:span 6}
      .col-4{grid-column:span 4}
      .col-3{grid-column:span 3}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header bg-white border-bottom">
    <div class="container py-2 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <span class="badge text-bg-primary rounded-pill">SPTA</span>
        <div>
          <div class="fw-bold">Admin Dashboard</div>
          <small class="text-muted">Manage data for the public portal</small>
        </div>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <button id="btnExportJSON" class="btn btn-outline-primary btn-sm">Export JSON</button>
        <button id="btnImportJSON" class="btn btn-outline-secondary btn-sm">Import JSON</button>
        <button id="btnPortalSnippet" class="btn btn-outline-dark btn-sm">Export Portal JS Snippet</button>
        <button id="btnSyncMake" class="btn btn-success btn-sm">Sync to Cloud</button>
        <button id="btnLogout" class="btn btn-outline-danger btn-sm">Logout</button>
        <input id="importFile" type="file" accept=".json" hidden>
      </div>
    </div>
  </div>

  <!-- Auth Overlay -->
  <div id="authOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-dark bg-opacity-50" style="z-index: 2000; display:none;">
    <div class="card shadow-soft" style="max-width:420px;width:92%;">
      <div class="card-body">
        <h5 class="mb-2">Admin Login</h5>
        <p class="text-muted small mb-3">Sign in with a one-time code sent to your email.</p>

        <div id="authStepEmail">
          <label class="form-label">Email</label>
          <input id="authEmail" type="email" class="form-control" placeholder="you@school.edu">
          <button id="btnSendCode" class="btn btn-primary w-100 mt-3">Send code</button>
        </div>

        <div id="authStepCode" class="d-none">
          <label class="form-label">Enter 6-digit code</label>
          <input id="authCode" inputmode="numeric" pattern="[0-9]*" maxlength="6" class="form-control" placeholder="123456">
          <button id="btnVerifyCode" class="btn btn-success w-100 mt-3">Verify & Sign in</button>
          <button id="btnBackEmail" class="btn btn-link w-100 mt-2">Use a different email</button>
        </div>

        <div id="authMsg" class="small mt-3" style="min-height:1.25rem;"></div>
      </div>
    </div>
  </div>

  <div class="container my-3">
    <div class="row g-3">
      <!-- Sidebar -->
      <aside class="col-12 col-lg-3">
        <div class="card shadow-soft">
          <div class="card-body">
            <h6 class="text-muted mb-2">Sections</h6>
            <div class="nav nav-pills flex-column gap-1" id="adminTabs" role="tablist">
              <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-overview" type="button">Overview</button>
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-announcements" type="button">Announcements</button>
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-resolutions" type="button">Resolutions</button>
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-finance" type="button">Finance</button>
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-officers" type="button">Officers</button>
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-settings" type="button">Settings</button>
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-audit" type="button">Audit Log</button>
            </div>
          </div>
        </div>
      </aside>

      <!-- Content -->
      <main class="col-12 col-lg-9 tab-content">
        <!-- OVERVIEW -->
        <section class="tab-pane fade show active" id="tab-overview">
          <div class="row g-3">
            <div class="col-6 col-md-3"><div class="card shadow-soft"><div class="card-body"><div class="text-muted mini">Announcements</div><div class="h4 mb-0" id="kpi-ann">0</div></div></div></div>
            <div class="col-6 col-md-3"><div class="card shadow-soft"><div class="card-body"><div class="text-muted mini">Resolutions</div><div class="h4 mb-0" id="kpi-reso">0</div></div></div></div>
            <div class="col-6 col-md-3"><div class="card shadow-soft"><div class="card-body"><div class="text-muted mini">Income Items</div><div class="h4 mb-0" id="kpi-inc">0</div></div></div></div>
            <div class="col-6 col-md-3"><div class="card shadow-soft"><div class="card-body"><div class="text-muted mini">Officers</div><div class="h4 mb-0" id="kpi-off">0</div></div></div></div>
          </div>

          <div class="card shadow-soft mt-3">
            <div class="card-body">
              <h6 class="mb-2">Quick how-to</h6>
              <ol class="mb-0">
                <li>Add your data in each section (Announcements, Resolutions, Finance, Officers).</li>
                <li>Use <strong>Export JSON</strong> to save a <code>spta-data.json</code> backup.</li>
                <li>Use <strong>Export Portal JS Snippet</strong> and paste into your public site while you’re not yet fetching JSON.</li>
                <li>Click <strong>Sync to Cloud</strong> to trigger your Make scenario (Drive/GitHub updates, notifications, etc.).</li>
              </ol>
            </div>
          </div>
        </section>

        <!-- ANNOUNCEMENTS -->
        <section class="tab-pane fade" id="tab-announcements">
          <div class="card shadow-soft">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <h5 class="mb-0">Announcements</h5>
                <button class="btn btn-primary btn-sm" onclick="openAnnForm()">Add Announcement</button>
              </div>

              <div id="annForm" class="border rounded p-3 mb-3 d-none">
                <div class="form-grid">
                  <div class="col-6">
                    <label class="form-label">Title</label>
                    <input id="annTitle" type="text" class="form-control" placeholder="Title">
                  </div>
                  <div class="col-6">
                    <label class="form-label">Link (optional)</label>
                    <input id="annLink" type="text" class="form-control" placeholder="#tab-projects or https://...">
                  </div>
                  <div class="col-12">
                    <label class="form-label">Body</label>
                    <textarea id="annBody" class="form-control" rows="3" placeholder="Message"></textarea>
                  </div>
                  <div class="col-6">
                    <label class="form-label">Publish Date</label>
                    <input id="annDate" type="date" class="form-control">
                  </div>
                  <div class="col-6 d-flex align-items-end justify-content-end gap-2">
                    <button class="btn btn-secondary" onclick="cancelAnn()">Cancel</button>
                    <button id="annSaveBtn" class="btn btn-primary" onclick="saveAnn()">Save</button>
                  </div>
                </div>
                <input id="annIdx" type="hidden">
              </div>

              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead class="table-light">
                    <tr><th>Title</th><th>Link</th><th>Date</th><th class="text-end">Actions</th></tr>
                  </thead>
                  <tbody id="annTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- RESOLUTIONS -->
        <section class="tab-pane fade" id="tab-resolutions">
          <div class="card shadow-soft">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <h5 class="mb-0">Resolutions</h5>
                <button class="btn btn-primary btn-sm" onclick="openResoForm()">Add Resolution</button>
              </div>

              <div id="resoForm" class="border rounded p-3 mb-3 d-none">
                <div class="form-grid">
                  <div class="col-3"><label class="form-label">Number</label><input id="rNo" class="form-control" placeholder="2025-001"></div>
                  <div class="col-9"><label class="form-label">Title</label><input id="rTitle" class="form-control" placeholder="Resolution Title"></div>
                  <div class="col-6"><label class="form-label">Nominated Lead</label><input id="rLead" class="form-control" placeholder="Name / Role"></div>
                  <div class="col-6">
                    <label class="form-label">Status</label>
                    <select id="rStatus" class="form-select">
                      <option>Proposed</option>
                      <option>Under Review</option>
                      <option>Approved</option>
                      <option>Disapproved</option>
                    </select>
                  </div>
                  <div class="col-12"><label class="form-label">Basis</label><input id="rBasis" class="form-control" placeholder="DepEd Order..., etc."></div>
                  <div class="col-9"><label class="form-label">PDF File (relative URL)</label><input id="rPdf" class="form-control" placeholder="assets/resolutions/Your File.pdf"></div>
                  <div class="col-3 d-flex align-items-end justify-content-end gap-2">
                    <button class="btn btn-secondary" onclick="cancelReso()">Cancel</button>
                    <button id="resoSaveBtn" class="btn btn-primary" onclick="saveReso()">Save</button>
                  </div>
                  <input id="rIdx" type="hidden">
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th style="width:105px">Reso No.</th><th>Title</th><th style="width:220px">Lead</th><th style="width:140px">Status</th><th>Basis</th><th style="width:120px">PDF</th><th class="text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="resoTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- FINANCE -->
        <section class="tab-pane fade" id="tab-finance">
          <div class="card shadow-soft mb-3">
            <div class="card-body">
              <h5 class="mb-3">Opening Balance</h5>
              <div class="row g-2 align-items-end">
                <div class="col-12 col-md-4">
                  <label class="form-label">Amount (₱)</label>
                  <input id="finOpening" type="number" class="form-control" step="1" min="0" placeholder="15000">
                </div>
                <div class="col-12 col-md-2">
                  <button class="btn btn-primary" onclick="saveOpening()">Save</button>
                </div>
                <div class="col-12 col-md-6 text-muted">
                  <small>Matches the “Opening Balance” card in the public portal.</small>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-12 col-xl-6">
              <div class="card shadow-soft">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <h6 class="mb-0">Income</h6>
                    <button class="btn btn-primary btn-sm" onclick="openIncomeForm()">Add Income</button>
                  </div>
                  <div id="incForm" class="border rounded p-3 mb-3 d-none">
                    <div class="form-grid">
                      <div class="col-4"><label class="form-label">Date</label><input id="incDate" type="date" class="form-control"></div>
                      <div class="col-8"><label class="form-label">Source</label><input id="incSource" class="form-control" placeholder="Parents Donations"></div>
                      <div class="col-6"><label class="form-label">Reference</label><input id="incRef" class="form-control" placeholder="#DON-001"></div>
                      <div class="col-6"><label class="form-label">Amount (₱)</label><input id="incAmount" type="number" class="form-control" step="1" min="0"></div>
                      <div class="col-12 d-flex justify-content-end gap-2">
                        <button class="btn btn-secondary" onclick="cancelIncome()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveIncome()">Save</button>
                      </div>
                      <input id="incIdx" type="hidden">
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                      <thead class="table-light"><tr><th>Date</th><th>Source</th><th>Ref</th><th class="text-end">Amount</th><th class="text-end">Actions</th></tr></thead>
                      <tbody id="incTable"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 col-xl-6">
              <div class="card shadow-soft">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <h6 class="mb-0">Expenses</h6>
                    <button class="btn btn-primary btn-sm" onclick="openExpForm()">Add Expense</button>
                  </div>
                  <div id="expForm" class="border rounded p-3 mb-3 d-none">
                    <div class="form-grid">
                      <div class="col-4"><label class="form-label">Date</label><input id="expDate" type="date" class="form-control"></div>
                      <div class="col-8"><label class="form-label">Purpose</label><input id="expPurpose" class="form-control" placeholder="Fans for 1-Camia"></div>
                      <div class="col-6"><label class="form-label">Reference</label><input id="expRef" class="form-control" placeholder="#EXP-001"></div>
                      <div class="col-6"><label class="form-label">Amount (₱)</label><input id="expAmount" type="number" class="form-control" step="1" min="0"></div>
                      <div class="col-12 d-flex justify-content-end gap-2">
                        <button class="btn btn-secondary" onclick="cancelExpense()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveExpense()">Save</button>
                      </div>
                      <input id="expIdx" type="hidden">
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                      <thead class="table-light"><tr><th>Date</th><th>Purpose</th><th>Ref</th><th class="text-end">Amount</th><th class="text-end">Actions</th></tr></thead>
                      <tbody id="expTable"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- OFFICERS -->
        <section class="tab-pane fade" id="tab-officers">
          <div class="card shadow-soft">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <h5 class="mb-0">Officers</h5>
                <button class="btn btn-primary btn-sm" onclick="openOfficerForm()">Add Officer</button>
              </div>

              <div id="offForm" class="border rounded p-3 mb-3 d-none">
                <div class="form-grid">
                  <div class="col-6"><label class="form-label">Name</label><input id="offName" class="form-control" placeholder="Full Name"></div>
                  <div class="col-6"><label class="form-label">Role</label><input id="offRole" class="form-control" placeholder="President"></div>
                  <div class="col-12"><label class="form-label">Photo URL (relative)</label><input id="offPhoto" class="form-control" placeholder="assets/photos/officers/01pres.png"></div>
                  <div class="col-12 d-flex justify-content-end gap-2">
                    <button class="btn btn-secondary" onclick="cancelOfficer()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveOfficer()">Save</button>
                  </div>
                  <input id="offIdx" type="hidden">
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead class="table-light"><tr><th>Name</th><th>Role</th><th>Photo</th><th class="text-end">Actions</th></tr></thead>
                  <tbody id="offTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- SETTINGS -->
        <section class="tab-pane fade" id="tab-settings">
          <div class="card shadow-soft">
            <div class="card-body">
              <h5 class="mb-3">Settings</h5>
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <label class="form-label">PDF base path</label>
                  <input id="cfgPdfBase" class="form-control" placeholder="assets/resolutions/">
                  <div class="form-text">Used by the Portal JS Snippet when building file links.</div>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Admin display name</label>
                  <input id="cfgAdminName" class="form-control" placeholder="Secretary / Admin">
                  <div class="form-text">Used in the audit log.</div>
                </div>
                <div class="col-12">
                  <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- AUDIT -->
        <section class="tab-pane fade" id="tab-audit">
          <div class="card shadow-soft">
            <div class="card-body">
              <h5 class="mb-3">Audit Log</h5>
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead class="table-light"><tr><th>Timestamp</th><th>Actor</th><th>Action</th></tr></thead>
                  <tbody id="auditTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal: Portal JS Snippet -->
  <div class="modal fade" id="snippetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Portal JS Snippet</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
<textarea id="snippetArea" class="form-control" rows="16"></textarea>
<div class="form-text mt-2">Copy this into your public portal’s &lt;script&gt; where <code>resolutionsData</code> and <code>fileIndex</code> (and optionally <code>officers</code>, <code>announcements</code>) are defined.</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-primary" onclick="copySnippet()">Copy to Clipboard</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ===========================
       Make.com Passwordless Auth
       =========================== */
    // REPLACE these with your Make webhook URLs:
    const AUTH_REQUEST_URL = 'https://hook.make.com/REPLACE_WITH_auth_request';
    const AUTH_VERIFY_URL  = 'https://hook.make.com/REPLACE_WITH_auth_verify';
    const MAKE_SYNC_URL    = 'https://hook.make.com/REPLACE_WITH_sync';

    const SESSION_KEY = 'spta_admin_session_v1'; // {token, expISO, email}

    function getSession(){
      try { return JSON.parse(localStorage.getItem(SESSION_KEY) || '{}'); } catch { return {}; }
    }
    function setSession(obj){ localStorage.setItem(SESSION_KEY, JSON.stringify(obj||{})); }
    function clearSession(){ localStorage.removeItem(SESSION_KEY); }
    function isSessionValid(sess){
      if(!sess || !sess.token || !sess.expISO) return false;
      return new Date(sess.expISO).getTime() > Date.now() + 30*1000; // 30s skew
    }

    const $ = (s)=>document.querySelector(s);
    function showAuth(show){
      $('#authOverlay').style.display = show ? 'flex' : 'none';
      const msg = $('#authMsg'); if(msg){ msg.textContent = ''; msg.className = 'small mt-3'; }
      if(show){
        $('#authStepEmail').classList.remove('d-none');
        $('#authStepCode').classList.add('d-none');
        $('#authEmail') && $('#authEmail').focus();
      }
    }

    async function authedFetch(url, opts={}){
      const sess = getSession();
      if(!isSessionValid(sess)) { showAuth(true); throw new Error('Not authenticated'); }
      opts.headers = Object.assign({}, opts.headers, { 'Authorization': `Bearer ${sess.token}` });
      return fetch(url, opts);
    }

    // Wire login flow
    document.addEventListener('DOMContentLoaded', ()=>{
      const sess = getSession();
      showAuth(!isSessionValid(sess));

      $('#btnSendCode').addEventListener('click', async ()=>{
        const email = ($('#authEmail').value||'').trim().toLowerCase();
        const msg = $('#authMsg');
        if(!email){ msg.textContent = 'Please enter your email.'; msg.classList.add('text-danger'); return; }
        try{
          const res = await fetch(AUTH_REQUEST_URL, {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ email })
          });
          const json = await res.json().catch(()=>({}));
          if(!res.ok || !json.ok){ throw new Error(json.error || 'Failed sending code'); }
          $('#authStepEmail').classList.add('d-none');
          $('#authStepCode').classList.remove('d-none');
          $('#authCode').focus();
          msg.textContent = 'Code sent. Check your inbox.'; msg.classList.add('text-success'); msg.classList.remove('text-danger');
          sessionStorage.setItem('auth_email', email);
        }catch(err){
          msg.textContent = err.message || 'Could not send code.'; msg.classList.add('text-danger'); msg.classList.remove('text-success');
        }
      });

      $('#btnVerifyCode').addEventListener('click', async ()=>{
        const email = sessionStorage.getItem('auth_email') || ($('#authEmail').value||'').trim().toLowerCase();
        const code  = ($('#authCode').value||'').trim();
        const msg = $('#authMsg');
        if(!email || code.length !== 6){ msg.textContent = 'Enter the 6-digit code.'; msg.classList.add('text-danger'); return; }
        try{
          const res = await fetch(AUTH_VERIFY_URL, {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ email, code })
          });
          const json = await res.json().catch(()=>({}));
          if(!res.ok || !json.ok || !json.token){ throw new Error(json.error || 'Invalid or expired code.'); }
          setSession({ token: json.token, expISO: json.exp, email });
          showAuth(false);
        }catch(err){
          msg.textContent = err.message || 'Verification failed.'; msg.classList.add('text-danger'); msg.classList.remove('text-success');
        }
      });

      $('#btnBackEmail').addEventListener('click', ()=>{
        $('#authStepCode').classList.add('d-none');
        $('#authStepEmail').classList.remove('d-none');
        $('#authMsg').textContent = '';
      });

      // Logout
      $('#btnLogout').addEventListener('click', ()=>{
        clearSession();
        showAuth(true);
      });
    });
  </script>

  <script>
    /* ===========================
       Data Store + CRUD (unchanged)
       =========================== */
    const LS_KEY = 'spta_admin_store_v1';

    const defaultStore = () => ({
      config: { pdfBase:'assets/resolutions/', adminName:'Admin' },
      announcements: [],
      resolutions: [], // {no,title,lead,basis,status,pdf}
      finance: { opening: 15000, income: [], expenses: [] }, // {date,source/ref,purpose,amount}
      officers: [], // {name,role,photo}
      audit: [] // {ts, actor, action}
    });

    function loadStore(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : defaultStore();
      }catch(e){ console.error(e); return defaultStore(); }
    }
    let STORE = loadStore();

    function saveStore(){
      localStorage.setItem(LS_KEY, JSON.stringify(STORE));
      refreshKPIs();
    }
    function log(action){
      const ts = new Date().toISOString().replace('T',' ').slice(0,16);
      STORE.audit.unshift({ts, actor: STORE.config.adminName || 'Admin', action});
      saveStore(); renderAudit();
    }

    // Utils
    const peso = n => `₱${(Number(n)||0).toLocaleString('en-PH',{maximumFractionDigits:0})}`;
    const fmtDate = d => d || '';
    function download(filename, text){
      const blob = new Blob([text], {type:'application/json;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
      URL.revokeObjectURL(url);
    }

    // KPIs
    function refreshKPIs(){
      document.getElementById('kpi-ann').textContent = STORE.announcements.length;
      document.getElementById('kpi-reso').textContent = STORE.resolutions.length;
      document.getElementById('kpi-inc').textContent = STORE.finance.income.length;
      document.getElementById('kpi-off').textContent = STORE.officers.length;
      document.getElementById('finOpening').value = STORE.finance.opening ?? 0;
      document.getElementById('cfgPdfBase').value = STORE.config.pdfBase || '';
      document.getElementById('cfgAdminName').value = STORE.config.adminName || '';
    }

    // Announcements CRUD
    function openAnnForm(){ document.getElementById('annForm').classList.remove('d-none'); }
    function cancelAnn(){ document.getElementById('annForm').classList.add('d-none'); clearAnnForm(); }
    function clearAnnForm(){ ['annTitle','annLink','annBody','annDate','annIdx'].forEach(id=>document.getElementById(id).value=''); }
    function saveAnn(){
      const title = document.getElementById('annTitle').value.trim();
      if(!title){ alert('Title is required'); return; }
      const link = document.getElementById('annLink').value.trim();
      const body = document.getElementById('annBody').value.trim();
      const date = document.getElementById('annDate').value;
      const idx = document.getElementById('annIdx').value;
      const item = {title, link, body, date};
      if(idx===''){ STORE.announcements.unshift(item); log(`Added announcement: ${title}`); }
      else{ STORE.announcements[idx] = item; log(`Updated announcement: ${title}`); }
      saveStore(); renderAnnouncements(); cancelAnn();
    }
    function editAnn(i){
      const a = STORE.announcements[i];
      document.getElementById('annTitle').value = a.title || '';
      document.getElementById('annLink').value  = a.link || '';
      document.getElementById('annBody').value  = a.body || '';
      document.getElementById('annDate').value  = a.date || '';
      document.getElementById('annIdx').value   = i;
      openAnnForm();
    }
    function delAnn(i){
      if(!confirm('Delete this announcement?')) return;
      const title = STORE.announcements[i]?.title || '';
      STORE.announcements.splice(i,1);
      saveStore(); renderAnnouncements(); log(`Deleted announcement: ${title}`);
    }
    function renderAnnouncements(){
      const tb = document.getElementById('annTable'); tb.innerHTML='';
      STORE.announcements.forEach((a,i)=>{
        tb.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${a.title||''}</td>
            <td>${a.link||''}</td>
            <td>${a.date||''}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-secondary me-1" onclick="editAnn(${i})">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="delAnn(${i})">Delete</button>
            </td>
          </tr>`);
      });
    }

    // Resolutions CRUD
    function openResoForm(){ document.getElementById('resoForm').classList.remove('d-none'); }
    function cancelReso(){ document.getElementById('resoForm').classList.add('d-none'); clearResoForm(); }
    function clearResoForm(){
      ['rNo','rTitle','rLead','rStatus','rBasis','rPdf','rIdx'].forEach(id=>{
        if(id==='rStatus') document.getElementById(id).value='Proposed'; else document.getElementById(id).value='';
      });
    }
    function saveReso(){
      const no = document.getElementById('rNo').value.trim();
      const title = document.getElementById('rTitle').value.trim();
      if(!no || !title){ alert('Resolution number and title are required'); return; }
      const lead  = document.getElementById('rLead').value.trim();
      const status= document.getElementById('rStatus').value;
      const basis = document.getElementById('rBasis').value.trim();
      let pdf     = document.getElementById('rPdf').value.trim();
      if(pdf && !pdf.startsWith('http') && !pdf.startsWith('assets/')){
        pdf = (STORE.config.pdfBase || 'assets/resolutions/') + pdf;
      }
      const idx = document.getElementById('rIdx').value;
      const item = {no, title, lead, basis, status, pdf};
      if(idx===''){ STORE.resolutions.push(item); log(`Added resolution ${no}`); }
      else{ STORE.resolutions[idx] = item; log(`Updated resolution ${no}`); }
      saveStore(); renderResolutions(); cancelReso();
    }
    function editReso(i){
      const r = STORE.resolutions[i];
      document.getElementById('rNo').value = r.no||'';
      document.getElementById('rTitle').value = r.title||'';
      document.getElementById('rLead').value = r.lead||'';
      document.getElementById('rStatus').value = r.status||'Proposed';
      document.getElementById('rBasis').value = r.basis||'';
      document.getElementById('rPdf').value = r.pdf||'';
      document.getElementById('rIdx').value = i;
      openResoForm();
    }
    function delReso(i){
      if(!confirm('Delete this resolution?')) return;
      const no = STORE.resolutions[i]?.no || '';
      STORE.resolutions.splice(i,1);
      saveStore(); renderResolutions(); log(`Deleted resolution ${no}`);
    }
    function renderResolutions(){
      const tb = document.getElementById('resoTable'); tb.innerHTML='';
      const rows = [...STORE.resolutions].sort((a,b)=> (a.no||'').localeCompare(b.no||''));
      rows.forEach((r)=>{
        const i = STORE.resolutions.indexOf(r);
        tb.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${r.no||''}</td>
            <td>${r.title||''}</td>
            <td>${r.lead||''}</td>
            <td>${r.status||''}</td>
            <td>${r.basis||''}</td>
            <td>${r.pdf ? '<span class="text-success">linked</span>' : '<span class="text-muted">—</span>'}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-secondary me-1" onclick="editReso(${i})">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="delReso(${i})">Delete</button>
            </td>
          </tr>`);
      });
    }

    // Finance CRUD
    function saveOpening(){
      const v = Number(document.getElementById('finOpening').value||0);
      STORE.finance.opening = v; saveStore(); log(`Updated opening balance to ${peso(v)}`);
    }
    // Income
    function openIncomeForm(){ document.getElementById('incForm').classList.remove('d-none'); }
    function cancelIncome(){ document.getElementById('incForm').classList.add('d-none'); clearIncomeForm(); }
    function clearIncomeForm(){ ['incDate','incSource','incRef','incAmount','incIdx'].forEach(id=>document.getElementById(id).value=''); }
    function saveIncome(){
      const rec = {
        date: document.getElementById('incDate').value,
        source: document.getElementById('incSource').value.trim(),
        ref: document.getElementById('incRef').value.trim(),
        amount: Number(document.getElementById('incAmount').value||0)
      };
      if(!rec.date || !rec.source){ alert('Date and Source are required'); return; }
      const idx = document.getElementById('incIdx').value;
      if(idx===''){ STORE.finance.income.push(rec); log(`Added income: ${rec.source}`); }
      else{ STORE.finance.income[idx]=rec; log(`Updated income: ${rec.source}`); }
      saveStore(); renderIncome(); cancelIncome();
    }
    function editIncome(i){
      const r = STORE.finance.income[i];
      document.getElementById('incDate').value = r.date||'';
      document.getElementById('incSource').value = r.source||'';
      document.getElementById('incRef').value = r.ref||'';
      document.getElementById('incAmount').value = r.amount||'';
      document.getElementById('incIdx').value = i;
      openIncomeForm();
    }
    function delIncome(i){
      if(!confirm('Delete this income record?')) return;
      const s = STORE.finance.income[i]?.source || '';
      STORE.finance.income.splice(i,1);
      saveStore(); renderIncome(); log(`Deleted income: ${s}`);
    }
    function renderIncome(){
      const tb = document.getElementById('incTable'); tb.innerHTML='';
      const rows = [...STORE.finance.income].sort((a,b)=> (a.date||'').localeCompare(b.date||''));
      rows.forEach((r)=>{
        const i = STORE.finance.income.indexOf(r);
        tb.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${fmtDate(r.date)}</td>
            <td>${r.source||''}</td>
            <td>${r.ref||''}</td>
            <td class="text-end">${(r.amount||0).toLocaleString('en-PH')}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-secondary me-1" onclick="editIncome(${i})">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="delIncome(${i})">Delete</button>
            </td>
          </tr>`);
      });
    }

    // Expenses
    function openExpForm(){ document.getElementById('expForm').classList.remove('d-none'); }
    function cancelExpense(){ document.getElementById('expForm').classList.add('d-none'); clearExpForm(); }
    function clearExpForm(){ ['expDate','expPurpose','expRef','expAmount','expIdx'].forEach(id=>document.getElementById(id).value=''); }
    function saveExpense(){
      const rec = {
        date: document.getElementById('expDate').value,
        purpose: document.getElementById('expPurpose').value.trim(),
        ref: document.getElementById('expRef').value.trim(),
        amount: Number(document.getElementById('expAmount').value||0)
      };
      if(!rec.date || !rec.purpose){ alert('Date and Purpose are required'); return; }
      const idx = document.getElementById('expIdx').value;
      if(idx===''){ STORE.finance.expenses.push(rec); log(`Added expense: ${rec.purpose}`); }
      else{ STORE.finance.expenses[idx]=rec; log(`Updated expense: ${rec.purpose}`); }
      saveStore(); renderExpenses(); cancelExpense();
    }
    function editExpense(i){
      const r = STORE.finance.expenses[i];
      document.getElementById('expDate').value = r.date||'';
      document.getElementById('expPurpose').value = r.purpose||'';
      document.getElementById('expRef').value = r.ref||'';
      document.getElementById('expAmount').value = r.amount||'';
      document.getElementById('expIdx').value = i;
      openExpForm();
    }
    function delExpense(i){
      if(!confirm('Delete this expense record?')) return;
      const s = STORE.finance.expenses[i]?.purpose || '';
      STORE.finance.expenses.splice(i,1);
      saveStore(); renderExpenses(); log(`Deleted expense: ${s}`);
    }
    function renderExpenses(){
      const tb = document.getElementById('expTable'); tb.innerHTML='';
      const rows = [...STORE.finance.expenses].sort((a,b)=> (a.date||'').localeCompare(b.date||''));
      rows.forEach((r)=>{
        const i = STORE.finance.expenses.indexOf(r);
        tb.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${fmtDate(r.date)}</td>
            <td>${r.purpose||''}</td>
            <td>${r.ref||''}</td>
            <td class="text-end">${(r.amount||0).toLocaleString('en-PH')}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-secondary me-1" onclick="editExpense(${i})">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="delExpense(${i})">Delete</button>
            </td>
          </tr>`);
      });
    }

    // Officers
    function openOfficerForm(){ document.getElementById('offForm').classList.remove('d-none'); }
    function cancelOfficer(){ document.getElementById('offForm').classList.add('d-none'); clearOfficerForm(); }
    function clearOfficerForm(){ ['offName','offRole','offPhoto','offIdx'].forEach(id=>document.getElementById(id).value=''); }
    function saveOfficer(){
      const name = document.getElementById('offName').value.trim();
      const role = document.getElementById('offRole').value.trim();
      if(!name || !role){ alert('Name and Role are required'); return; }
      const photo = document.getElementById('offPhoto').value.trim();
      const idx = document.getElementById('offIdx').value;
      const item = {name, role, photo};
      if(idx===''){ STORE.officers.push(item); log(`Added officer: ${name}`); }
      else{ STORE.officers[idx]=item; log(`Updated officer: ${name}`); }
      saveStore(); renderOfficers(); cancelOfficer();
    }
    function editOfficer(i){
      const o = STORE.officers[i];
      document.getElementById('offName').value = o.name||'';
      document.getElementById('offRole').value = o.role||'';
      document.getElementById('offPhoto').value = o.photo||'';
      document.getElementById('offIdx').value = i;
      openOfficerForm();
    }
    function delOfficer(i){
      if(!confirm('Delete this officer?')) return;
      const n = STORE.officers[i]?.name || '';
      STORE.officers.splice(i,1);
      saveStore(); renderOfficers(); log(`Deleted officer: ${n}`);
    }
    function renderOfficers(){
      const tb = document.getElementById('offTable'); tb.innerHTML='';
      STORE.officers.forEach((o,i)=>{
        tb.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${o.name||''}</td>
            <td>${o.role||''}</td>
            <td class="text-truncate" style="max-width:260px">${o.photo||''}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-secondary me-1" onclick="editOfficer(${i})">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="delOfficer(${i})">Delete</button>
            </td>
          </tr>`);
      });
    }

    // Settings / Audit
    function saveSettings(){
      STORE.config.pdfBase = document.getElementById('cfgPdfBase').value.trim() || 'assets/resolutions/';
      STORE.config.adminName = document.getElementById('cfgAdminName').value.trim() || 'Admin';
      saveStore(); log('Updated settings');
      alert('Settings saved.');
    }
    function renderAudit(){
      const tb = document.getElementById('auditTable'); tb.innerHTML='';
      STORE.audit.forEach(a=>{
        tb.insertAdjacentHTML('beforeend', `<tr><td>${a.ts}</td><td>${a.actor}</td><td>${a.action}</td></tr>`);
      });
    }

    // Import / Export / Snippet
    document.getElementById('btnExportJSON').addEventListener('click', ()=>{
      download('spta-data.json', JSON.stringify(STORE, null, 2));
    });
    document.getElementById('btnImportJSON').addEventListener('click', ()=> document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text();
      try{
        const data = JSON.parse(text);
        STORE = Object.assign(defaultStore(), data);
        saveStore();
        renderAll();
        alert('Import successful.');
        log('Imported JSON data');
      }catch(err){ alert('Import failed: invalid JSON'); console.error(err); }
      e.target.value='';
    });

    document.getElementById('btnPortalSnippet').addEventListener('click', ()=>{
      const pdfBase = STORE.config.pdfBase || 'assets/resolutions/';
      const resolutionsData = STORE.resolutions.map(r => ({
        no: r.no, title: r.title, lead: r.lead, basis: r.basis
      })).sort((a,b)=> (a.no||'').localeCompare(b.no||''));
      const fileIndex = {};
      STORE.resolutions.forEach(r=>{
        if(r.no && r.pdf){
          const fn = r.pdf.startsWith('http') ? r.pdf : (r.pdf.startsWith('assets/') ? r.pdf : pdfBase + r.pdf);
          const onlyName = fn.split('/').pop();
          fileIndex[r.no] = onlyName;
        }
      });
      const officers = STORE.officers;
      const announcements = STORE.announcements;
      const snippet = `// ---- Generated by Admin ----
const resolutionsData = ${JSON.stringify(resolutionsData, null, 2)};

const fileIndex = ${JSON.stringify(fileIndex, null, 2)};

// Optional (if your portal reads these):
const officers = ${JSON.stringify(officers, null, 2)};
const announcementsData = ${JSON.stringify(announcements, null, 2)};`;
      document.getElementById('snippetArea').value = snippet;
      const modal = new bootstrap.Modal('#snippetModal'); modal.show();
    });
    function copySnippet(){
      const ta = document.getElementById('snippetArea');
      ta.select(); document.execCommand('copy');
    }

    // ---- Sync to Cloud (Make.com) ----
    document.getElementById('btnSyncMake').addEventListener('click', async ()=>{
      try{
        const res = await authedFetch(MAKE_SYNC_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(STORE)
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        log('Synced data to Make.com');
        alert('Synced to cloud successfully!');
      }catch(err){
        console.error(err);
        alert('Sync failed. Sign in and try again.');
        showAuth(true);
      }
    });

    // Render all
    function renderAll(){
      refreshKPIs();
      renderAnnouncements();
      renderResolutions();
      renderIncome();
      renderExpenses();
      renderOfficers();
      renderAudit();
    }
    document.addEventListener('DOMContentLoaded', renderAll);
  </script>
</body>
</html>
